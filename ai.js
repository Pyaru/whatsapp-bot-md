const fetch = require('node-fetch');

// ‡ßß. ‡¶è‡¶ü‡¶ø ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶•‡¶æ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶¨‡¶æ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶æ‡¶ó‡ßá)
async function getGeminiReply(userMessage) {
    // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ó‡ßç‡¶∞‡¶ø‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶¨‡¶æ ‡¶ñ‡ßÅ‡¶¨ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶•‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã
    return "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶¨‡¶á‡¶ü‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π‡ßá ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá 'request [‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ]' ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶è‡¶°‡¶Æ‡¶ø‡¶®‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§";
}

// ‡ß®. ‡¶è‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø üî•
async function extractBookKeyword(userText) {
    try {
        const instruction = `
        ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶π‡¶≤‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡¶ø‡¶∑‡ßü‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶¨‡¶æ ‡¶ï‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (Keyword) ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ‡•§
        ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶¨‡ßá ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡ßß‡¶ü‡¶ø ‡¶¨‡¶æ ‡ß®‡¶ü‡¶ø ‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶ï‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶¨‡ßá‡•§
        
        ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:
        ‡¶á‡¶®‡¶™‡ßÅ‡¶ü: "‡¶Æ‡ßá‡¶∞‡¶æ‡¶ú‡ßá‡¶∞ ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ú‡ßÅ‡¶Æ‡¶æ‡¶∞ ‡¶ü‡¶™‡¶ø‡¶ï" -> ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü: ‡¶Æ‡ßá‡¶∞‡¶æ‡¶ú
        ‡¶á‡¶®‡¶™‡ßÅ‡¶ü: "‡¶´‡¶§‡ßã‡ßü‡¶æ‡ßü‡ßá ‡¶∂‡¶æ‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶õ‡ßá?" -> ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü: ‡¶´‡¶§‡ßã‡ßü‡¶æ‡ßü‡ßá ‡¶∂‡¶æ‡¶Æ‡¶ø
        ‡¶á‡¶®‡¶™‡ßÅ‡¶ü: "‡¶ú‡¶æ‡¶®‡¶æ‡¶ú‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶ï‡¶æ‡¶®‡ßÅ‡¶®" -> ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü: ‡¶ú‡¶æ‡¶®‡¶æ‡¶ú‡¶æ
        ‡¶á‡¶®‡¶™‡ßÅ‡¶ü: "give me bukhari sharif" -> ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü: bukhari
        
        ‡¶è‡¶ñ‡¶® ‡¶è‡¶á ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø‡¶ü‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßã: "${userText}"
        `;

        const prompt = encodeURIComponent(instruction);
        const url = `https://text.pollinations.ai/${prompt}?model=openai`;

        const response = await fetch(url);
        const text = await response.text();

        // ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶ø‡¶Ç (‡¶Ø‡¶æ‡¶§‡ßá ‡¶¨‡¶æ‡ßú‡¶§‡¶ø ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶¨‡¶æ ‡¶¶‡¶æ‡ßú‡¶ø-‡¶ï‡¶Æ‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
        let keyword = text.trim().replace(/['"]+/g, '');
        
        // ‡¶Ø‡¶¶‡¶ø AI ‡¶≠‡ßÅ‡¶≤‡¶≠‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßá‡¶ï ‡¶¨‡ßú ‡¶≤‡¶æ‡¶á‡¶® ‡¶¶‡ßá‡ßü, ‡¶§‡¶¨‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡ßá‡¶ü‡¶ø ‡¶®‡ßá‡¶¨ ‡¶®‡¶æ
        if (keyword.length > 50) return userText; 
        
        return keyword;

    } catch (error) {
        console.error("Keyword Extract Error:", error);
        return userText; // ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶≤‡ßá ‡¶Ø‡¶æ ‡¶õ‡¶ø‡¶≤ ‡¶§‡¶æ‡¶á ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡¶¨
    }
}

module.exports = { getGeminiReply, extractBookKeyword };