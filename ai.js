const fetch = require('node-fetch');

async function getGeminiReply(userMessage) {
    try {
            const instruction = "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶π‡¶≤‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶¨‡¶ü‡•§ ‡¶ñ‡ßÅ‡¶¨ ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶¶‡ßç‡¶ß ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶æ‡¶ì‡•§";
                    const prompt = encodeURIComponent(`${instruction}\n\nUser said: "${userMessage}"`);

                            // üëá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡ßß: ‡¶Ü‡¶Æ‡¶∞‡¶æ URL-‡¶è '?model=openai' ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø‡•§
                                    // ‡¶è‡¶§‡ßá AI ‡¶Ü‡¶ú‡ßá‡¶¨‡¶æ‡¶ú‡ßá ‡¶ï‡ßã‡¶° ‡¶®‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá‡•§
                                            const url = `https://text.pollinations.ai/${prompt}?model=openai`;

                                                    const response = await fetch(url);

                                                            if (!response.ok) {
                                                                        throw new Error(`Server status: ${response.status}`);
                                                                                }

                                                                                        const text = await response.text();

                                                                                                // üëá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡ß®: ‡¶∏‡ßá‡¶´‡¶ü‡¶ø ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ (‡¶Ø‡¶¶‡¶ø ‡¶§‡¶¨‡ßÅ‡¶ì JSON ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ö‡¶≤‡ßá ‡¶Ü‡¶∏‡ßá)
                                                                                                        try {
                                                                                                                    // ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶¶‡ßá‡¶ñ‡¶¨ ‡¶è‡¶ü‡¶æ JSON ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
                                                                                                                                const json = JSON.parse(text);
                                                                                                                                            
                                                                                                                                                        // ‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∏‡¶≤ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶æ ‡¶®‡ßá‡¶¨
                                                                                                                                                                    if (json.content) return json.content;
                                                                                                                                                                                if (json.choices && json.choices[0].message.content) return json.choices[0].message.content;
                                                                                                                                                                                            
                                                                                                                                                                                                        return text; // ‡¶Ø‡¶¶‡¶ø ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶®‡¶æ ‡¶π‡ßü, ‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
                                                                                                                                                                                                                } catch (e) {
                                                                                                                                                                                                                            // ‡¶Ø‡¶¶‡¶ø JSON ‡¶®‡¶æ ‡¶π‡ßü (‡¶Ö‡¶∞‡ßç‡¶•‡¶æ‡ßé ‡¶™‡ßç‡¶≤‡ßá‡¶á‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü), ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶¨‡ßá
                                                                                                                                                                                                                                        return text;
                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                    } catch (error) {
                                                                                                                                                                                                                                                            console.error("AI Error:", error.message);
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                            // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á (‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™)
                                                                                                                                                                                                                                                                                    const msg = userMessage.toLowerCase();
                                                                                                                                                                                                                                                                                            if (msg.includes("‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ") || msg.includes("salam")) {
                                                                                                                                                                                                                                                                                                        return "‡¶ì‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ï‡ßÅ‡¶Æ‡ßÅ‡¶∏ ‡¶∏‡¶æ‡¶≤‡¶æ‡¶Æ! ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?";
                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                        return "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                            module.exports = { getGeminiReply };