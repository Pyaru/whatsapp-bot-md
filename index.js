const { default: makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys');
const pino = require('pino');
const express = require('express');
const app = express();

// ðŸ‘‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¬à¦Ÿà§‡à¦° à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° (+ à¦¬à¦¾à¦¦à§‡)
const phoneNumber = "8801865760508";

// ðŸ‘‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¨à¦¿à¦œà§‡à¦° (Admin) à¦¨à¦®à§à¦¬à¦° à¦¯à§‡à¦–à¦¾à¦¨à§‡ à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿ à¦¯à¦¾à¦¬à§‡
// à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿ: à¦•à¦¾à¦¨à§à¦Ÿà§à¦°à¦¿à¦•à§‹à¦¡+à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° + @s.whatsapp.net
// à¦‰à¦¦à¦¾à¦¹à¦°à¦£: "8801712345678@s.whatsapp.net"
const adminNumber = "96897657655@s.whatsapp.net"; 

// à¦¯à¦¾à¦°à¦¾ à¦à¦¡à¦®à¦¿à¦¨à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦•à¦¥à¦¾ à¦¬à¦²à¦›à§‡, à¦¤à¦¾à¦¦à§‡à¦° à¦²à¦¿à¦¸à§à¦Ÿ
const supportModeUsers = new Set();

// à¦¯à¦¾à¦°à¦¾ à¦¬à¦‡ à¦¸à¦¾à¦°à§à¦š à¦•à¦°à§‡ à¦²à¦¿à¦¸à§à¦Ÿ à¦ªà§‡à§Ÿà§‡à¦›à§‡, à¦¤à¦¾à¦¦à§‡à¦° à¦¡à¦¾à¦Ÿà¦¾
const userSearchSessions = new Map();

// à¦¡à¦¾à¦Ÿà¦¾à¦¬à§‡à¦¸ à¦à¦¬à¦‚ AI à¦«à¦¾à¦‡à¦² à¦•à¦¾à¦¨à§‡à¦•à§à¦Ÿ à¦•à¦°à¦¾
const booksDatabase = require('./books.json');
const { getGeminiReply } = require('./ai'); 

async function connectToWhatsApp() {
    const { state, saveCreds } = await useMultiFileAuthState('auth_info_baileys');

        const sock = makeWASocket({
                auth: state,
                        printQRInTerminal: false,
                                logger: pino({ level: "silent" }),
                                        browser: ["Ubuntu", "Chrome", "20.0.04"],
                                            });

                                                if (!sock.authState.creds.registered) {
                                                        setTimeout(async () => {
                                                                    try {
                                                                                    const code = await sock.requestPairingCode(phoneNumber);
                                                                                                    console.log(`\nYour Pairing Code: ${code}\n`);
                                                                                                                } catch (err) {
                                                                                                                                console.log("Error requesting pairing code: ", err);
                                                                                                                                            }
                                                                                                                                                    }, 3000);
                                                                                                                                                        }

                                                                                                                                                            sock.ev.on('creds.update', saveCreds);

                                                                                                                                                                sock.ev.on('connection.update', (update) => {
                                                                                                                                                                        const { connection, lastDisconnect } = update;
                                                                                                                                                                                if (connection === 'close') {
                                                                                                                                                                                            const shouldReconnect = lastDisconnect.error?.output?.statusCode !== DisconnectReason.loggedOut;
                                                                                                                                                                                                        if (shouldReconnect) {
                                                                                                                                                                                                                        connectToWhatsApp();
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                            } else if (connection === 'open') {
                                                                                                                                                                                                                                                        console.log('âœ… WhatsApp à¦•à¦¾à¦¨à§‡à¦•à§à¦Ÿà§‡à¦¡!');
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                        sock.ev.on('messages.upsert', async m => {
                                                                                                                                                                                                                                                                                const msg = m.messages[0];
                                                                                                                                                                                                                                                                                        if (!msg.message || msg.key.fromMe) return;

                                                                                                                                                                                                                                                                                                const remoteJid = msg.key.remoteJid;
                                                                                                                                                                                                                                                                                                        const incomingText = (msg.message.conversation || msg.message.extendedTextMessage?.text || "").trim();
                                                                                                                                                                                                                                                                                                                const msgLower = incomingText.toLowerCase();

                                                                                                                                                                                                                                                                                                                        if (!incomingText) return; 

                                                                                                                                                                                                                                                                                                                                // ðŸ›‘ à§§. à¦¸à¦¾à¦ªà§‹à¦°à§à¦Ÿ à¦®à§‹à¦¡ à¦šà§‡à¦•
                                                                                                                                                                                                                                                                                                                                        if (msgLower === 'admin' || msgLower === 'help') {
                                                                                                                                                                                                                                                                                                                                                    supportModeUsers.add(remoteJid);
                                                                                                                                                                                                                                                                                                                                                                userSearchSessions.delete(remoteJid);
                                                                                                                                                                                                                                                                                                                                                                            await sock.sendMessage(remoteJid, { text: "ðŸ›‘ *à¦¸à¦¾à¦ªà§‹à¦°à§à¦Ÿ à¦®à§‹à¦¡ à¦…à¦¨!* à¦à¦–à¦¨ à¦à¦¡à¦®à¦¿à¦¨ à¦°à¦¿à¦ªà§à¦²à¦¾à¦‡ à¦¦à§‡à¦¬à§‡à¦¨à¥¤\nà¦¬à¦¨à§à¦§ à¦•à¦°à¦¤à§‡ *bot* à¦²à¦¿à¦–à§à¦¨à¥¤" });
                                                                                                                                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                        if (msgLower === 'bot' || msgLower === 'start') {
                                                                                                                                                                                                                                                                                                                                                                                                                    supportModeUsers.delete(remoteJid);
                                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, { text: "âœ… *à¦¬à¦Ÿ à¦šà¦¾à¦²à§ à¦¹à§Ÿà§‡à¦›à§‡!* à¦†à¦ªà¦¨à¦¿ à¦¬à¦‡ à¦–à§à¦à¦œà¦¤à§‡ à¦ªà¦¾à¦°à§‡à¦¨à¥¤" });
                                                                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (supportModeUsers.has(remoteJid)) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ðŸ‘‹ à§¨. à¦“à§Ÿà§‡à¦²à¦•à¦¾à¦® à¦®à§‡à¦¸à§‡à¦œ à¦“ à¦®à§‡à¦¨à§ (NEW FEATURE)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const greetings = ["hi", "hello", "salam", "à¦†à¦¸à¦¸à¦¾à¦²à¦¾à¦®à§ à¦†à¦²à¦¾à¦‡à¦•à§à¦®", "à¦¸à¦¾à¦²à¦¾à¦®", "menu", "à¦®à§‡à¦¨à§"];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (greetings.some(word => msgLower.includes(word))) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const menuText = `ðŸ“š *à¦†à¦¸à¦¸à¦¾à¦²à¦¾à¦®à§ à¦†à¦²à¦¾à¦‡à¦•à§à¦®!* à¦¸à§à¦¬à¦¾à¦—à¦¤à¦® à¦†à¦®à¦¾à¦¦à§‡à¦° à¦‡à¦¸à¦²à¦¾à¦®à¦¿à¦• à¦²à¦¾à¦‡à¦¬à§à¦°à§‡à¦°à¦¿ à¦¬à¦Ÿà§‡à¥¤\n\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     `à¦†à¦®à¦¿ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦•à§€à¦­à¦¾à¦¬à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à¦¿?\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  `-----------------------------------\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               `ðŸ” *à¦¬à¦‡ à¦–à§à¦à¦œà¦¤à§‡:* à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦¬à¦‡à§Ÿà§‡à¦° à¦¨à¦¾à¦® à¦²à¦¿à¦–à§à¦¨à¥¤\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `ðŸ“ *à¦¬à¦‡ à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿ:* 'à¦šà¦¾à¦‡ [à¦¬à¦‡à§Ÿà§‡à¦° à¦¨à¦¾à¦®]' à¦²à¦¿à¦–à§à¦¨à¥¤\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         `ðŸ›‘ *à¦à¦¡à¦®à¦¿à¦¨ à¦¹à§‡à¦²à§à¦ª:* 'admin' à¦²à¦¿à¦–à§à¦¨à¥¤\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      `ðŸ¤– *AI à¦šà§à¦¯à¦¾à¦Ÿ:* à¦¯à§‡à¦•à§‹à¦¨à§‹ à¦ªà§à¦°à¦¶à§à¦¨ à¦•à¦°à§à¦¨à¥¤\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   `-----------------------------------\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                `à¦‰à¦¦à¦¾à¦¹à¦°à¦£: *à¦«à¦¯à¦¼à¦¯à¦¾à¦¨à§‡ à¦¸à§à¦¨à§à¦¨à¦¾à¦¤* à¦¬à¦¾ *à¦šà¦¾à¦‡ à¦¨à§‡à¦•à§€à¦° à¦¦à¦¾à¦“à¦¯à¦¼à¦¾à¦¤*`;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // à¦†à¦ªà¦¨à¦¿ à¦šà¦¾à¦‡à¦²à§‡ à¦à¦–à¦¾à¦¨à§‡ à¦à¦•à¦Ÿà¦¿ à¦‡à¦®à§‡à¦œà¦“ à¦à¦¡ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¦¨ (image: {url: "..."})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await sock.sendMessage(remoteJid, { text: menuText });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ðŸ“¥ à§©. à¦¬à¦‡ à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿ à¦¸à¦¿à¦¸à§à¦Ÿà§‡à¦®
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (msgLower.startsWith("request") || msgLower.startsWith("à¦šà¦¾à¦‡") || msgLower.startsWith("à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿ")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const requestedBook = incomingText.replace(/request|à¦šà¦¾à¦‡|à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿ/i, "").trim();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!requestedBook) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(remoteJid, { text: "âš ï¸ à¦¦à§Ÿà¦¾ à¦•à¦°à§‡ à¦¬à¦‡à§Ÿà§‡à¦° à¦¨à¦¾à¦® à¦²à¦¿à¦–à§à¦¨à¥¤ \nà¦‰à¦¦à¦¾à¦¹à¦°à¦£: *à¦šà¦¾à¦‡ à¦«à¦¾à¦¯à¦¾à§Ÿà§‡à¦²à§‡ à¦†à¦®à¦²*" });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const requestMsg = `ðŸ”” *à¦¨à¦¤à§à¦¨ à¦¬à¦‡à§Ÿà§‡à¦° à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿ!* \n\nðŸ‘¤ à¦‡à¦‰à¦œà¦¾à¦°: ${remoteJid.split('@')[0]} \nðŸ“š à¦¬à¦‡: ${requestedBook}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (adminNumber.includes("880")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(adminNumber, { text: requestMsg });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await sock.sendMessage(remoteJid, { text: "âœ… à¦†à¦ªà¦¨à¦¾à¦° à¦°à¦¿à¦•à§‹à§Ÿà§‡à¦¸à§à¦Ÿà¦Ÿà¦¿ à¦à¦¡à¦®à¦¿à¦¨à§‡à¦° à¦•à¦¾à¦›à§‡ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à§Ÿà§‡à¦›à§‡à¥¤ à¦‡à¦¨à¦¶à¦¾à¦†à¦²à§à¦²à¦¾à¦¹ à¦¶à§€à¦˜à§à¦°à¦‡ à¦¬à¦‡à¦Ÿà¦¿ à¦¯à§à¦•à§à¦¤ à¦•à¦°à¦¾ à¦¹à¦¬à§‡à¥¤" });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ðŸ”¢ à§ª. à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à§Ÿà§‡ à¦¬à¦‡ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à¦¾
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (userSearchSessions.has(remoteJid) && !isNaN(incomingText)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const selectedIndex = parseInt(incomingText) - 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const pendingBooks = userSearchSessions.get(remoteJid);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (selectedIndex >= 0 && selectedIndex < pendingBooks.length) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const selectedBook = pendingBooks[selectedIndex];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(remoteJid, { text: `âœ… à¦†à¦ªà¦¨à¦¿ à¦¸à¦¿à¦²à§‡à¦•à§à¦Ÿ à¦•à¦°à§‡à¦›à§‡à¦¨: *${selectedBook.name}*\nà¦¬à¦‡à¦Ÿà¦¿ à¦†à¦ªà¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...` });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(remoteJid, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document: { url: selectedBook.link },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            mimetype: 'application/pdf',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fileName: `${selectedBook.name}.pdf`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                userSearchSessions.delete(remoteJid);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await sock.sendMessage(remoteJid, { text: "âŒ à¦­à§à¦² à¦¨à¦®à§à¦¬à¦°! à¦¦à§Ÿà¦¾ à¦•à¦°à§‡ à¦¤à¦¾à¦²à¦¿à¦•à¦¾à¦° à¦¸à¦ à¦¿à¦• à¦¨à¦®à§à¦¬à¦°à¦Ÿà¦¿ à¦²à¦¿à¦–à§à¦¨à¥¤" });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ðŸ“š à§«. à¦¬à¦‡ à¦–à§‹à¦à¦œà¦¾
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const matchingBooks = booksDatabase.filter(book =>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            book.name.toLowerCase().includes(msgLower)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (matchingBooks.length === 1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const foundBook = matchingBooks[0];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(remoteJid, { text: `ðŸ“š à¦ªà§‡à§Ÿà§‡à¦›à¦¿! *${foundBook.name}* à¦¬à¦‡à¦Ÿà¦¿ à¦†à¦ªà¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...` });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document: { url: foundBook.link },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                mimetype: 'application/pdf',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fileName: `${foundBook.name}.pdf`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        userSearchSessions.delete(remoteJid);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else if (matchingBooks.length > 1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            userSearchSessions.set(remoteJid, matchingBooks);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let bookList = "ðŸ“š *à¦à¦•à¦¾à¦§à¦¿à¦• à¦¬à¦‡ à¦ªà¦¾à¦“à§Ÿà¦¾ à¦—à§‡à¦›à§‡!*\nà¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡ à¦•à¦°à¦¤à§‡ à¦¶à§à¦§à§ à¦¨à¦®à§à¦¬à¦° (à¦¯à§‡à¦®à¦¨: 1, 2) à¦²à¦¿à¦–à§‡ à¦ªà¦¾à¦ à¦¾à¦¨:\n\n";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matchingBooks.forEach((book, index) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    bookList += `*${index + 1}.* ${book.name}\n`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await sock.sendMessage(remoteJid, { text: bookList });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // à¦¬à¦‡ à¦¨à¦¾ à¦ªà§‡à¦²à§‡ AI à¦°à¦¿à¦ªà§à¦²à¦¾à¦‡
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            userSearchSessions.delete(remoteJid);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await sock.sendPresenceUpdate('composing', remoteJid);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const aiResponse = await getGeminiReply(incomingText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, { text: aiResponse });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // à¦¸à¦¾à¦°à§à¦­à¦¾à¦° à¦¸à§‡à¦Ÿà¦†à¦ª
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.get('/', (req, res) => res.send('Bot is Running'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.listen(process.env.PORT || 3000, () => console.log('Server started'));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            connectToWhatsApp();