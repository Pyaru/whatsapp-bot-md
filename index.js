const { default: makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys');
const pino = require('pino');
const express = require('express');
const app = express();

// üëá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (+ ‡¶¨‡¶æ‡¶¶‡ßá)
const phoneNumber = "8801865760508";

// ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶è‡¶¨‡¶Ç AI ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
// ‡¶®‡ßã‡¶ü: ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® books.json ‡¶è‡¶¨‡¶Ç ai.js ‡¶´‡¶æ‡¶á‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡¶á ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá ‡¶Ü‡¶õ‡ßá
const booksDatabase = require('./books.json');
const { getGeminiReply } = require('./ai'); 

async function connectToWhatsApp() {
    const { state, saveCreds } = await useMultiFileAuthState('auth_info_baileys');

        const sock = makeWASocket({
                auth: state,
                        printQRInTerminal: false,
                                logger: pino({ level: "silent" }),
                                        browser: ["Ubuntu", "Chrome", "20.0.04"],
                                            });

                                                if (!sock.authState.creds.registered) {
                                                        setTimeout(async () => {
                                                                    try {
                                                                                    const code = await sock.requestPairingCode(phoneNumber);
                                                                                                    console.log(`\nYour Pairing Code: ${code}\n`);
                                                                                                                } catch (err) {
                                                                                                                                console.log("Error requesting pairing code: ", err);
                                                                                                                                            }
                                                                                                                                                    }, 3000);
                                                                                                                                                        }

                                                                                                                                                            sock.ev.on('creds.update', saveCreds);

                                                                                                                                                                sock.ev.on('connection.update', (update) => {
                                                                                                                                                                        const { connection, lastDisconnect } = update;
                                                                                                                                                                                if (connection === 'close') {
                                                                                                                                                                                            const shouldReconnect = lastDisconnect.error?.output?.statusCode !== DisconnectReason.loggedOut;
                                                                                                                                                                                                        if (shouldReconnect) {
                                                                                                                                                                                                                        connectToWhatsApp();
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                            } else if (connection === 'open') {
                                                                                                                                                                                                                                                        console.log('‚úÖ WhatsApp ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°!');
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                        sock.ev.on('messages.upsert', async m => {
                                                                                                                                                                                                                                                                                const msg = m.messages[0];
                                                                                                                                                                                                                                                                                        if (!msg.message || msg.key.fromMe) return;

                                                                                                                                                                                                                                                                                                const remoteJid = msg.key.remoteJid;
                                                                                                                                                                                                                                                                                                        const incomingText = (msg.message.conversation || msg.message.extendedTextMessage?.text || "").trim();

                                                                                                                                                                                                                                                                                                                if (!incomingText) return; // ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶π‡¶≤‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ

                                                                                                                                                                                                                                                                                                                        // ‡ßß. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá ‡¶¨‡¶á ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ
                                                                                                                                                                                                                                                                                                                                const foundBook = booksDatabase.find(book =>
                                                                                                                                                                                                                                                                                                                                            book.name.toLowerCase().includes(incomingText.toLowerCase())
                                                                                                                                                                                                                                                                                                                                                    );

                                                                                                                                                                                                                                                                                                                                                            if (foundBook) {
                                                                                                                                                                                                                                                                                                                                                                        // ‡¶¨‡¶á ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶≤‡ßá ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(remoteJid, { text: `üìö ‡¶™‡ßá‡ßü‡ßá‡¶õ‡¶ø! *${foundBook.name}* ‡¶¨‡¶á‡¶ü‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...` });

                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, {
                                                                                                                                                                                                                                                                                                                                                                                                                document: { url: foundBook.link },
                                                                                                                                                                                                                                                                                                                                                                                                                                mimetype: 'application/pdf',
                                                                                                                                                                                                                                                                                                                                                                                                                                                fileName: `${foundBook.name}.pdf`
                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // ‡ß®. ‡¶¨‡¶á ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶≤‡ßá AI ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶¨‡ßá
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ‡¶ü‡¶æ‡¶á‡¶™‡¶ø‡¶Ç ‡¶á‡¶´‡ßá‡¶ï‡ßç‡¶ü
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await sock.sendPresenceUpdate('composing', remoteJid);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const aiResponse = await getGeminiReply(incomingText);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, { text: aiResponse });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ‡¶ì‡ßü‡ßá‡¶¨ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ (Render ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.get('/', (req, res) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                res.send('WhatsApp Bot is Running Successfully!');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const PORT = process.env.PORT || 3000;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                app.listen(PORT, () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.log(`üåç Server is running on port ${PORT}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    connectToWhatsApp();