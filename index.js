const { default: makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys');
const pino = require('pino');
const express = require('express');
const app = express();

// ðŸ‘‡ à¦†à¦ªà¦¨à¦¾à¦° à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° à¦à¦–à¦¾à¦¨à§‡ à¦¬à¦¸à¦¾à¦¨ (+ à¦¬à¦¾à¦¦à§‡)
const phoneNumber = "8801865760508"; 

// à¦¡à¦¾à¦Ÿà¦¾à¦¬à§‡à¦¸ à¦à¦¬à¦‚ AI à¦«à¦¾à¦‡à¦² à¦•à¦¾à¦¨à§‡à¦•à§à¦Ÿ à¦•à¦°à¦¾
const booksDatabase = require('./books.json'); 
const { getGeminiReply } = require('./ai'); // à¦¨à¦¤à§à¦¨ à¦«à¦¾à¦‡à¦²à¦Ÿà¦¿ à¦•à¦² à¦•à¦°à¦¾ à¦¹à¦²à§‹

async function connectToWhatsApp() {
    const { state, saveCreds } = await useMultiFileAuthState('auth_info_baileys');
        
            const sock = makeWASocket({
                    auth: state,
                            printQRInTerminal: false,
                                    logger: pino({ level: "silent" }),
                                            browser: ["Ubuntu", "Chrome", "20.0.04"],
                                                });

                                                    if (!sock.authState.creds.registered) {
                                                            setTimeout(async () => {
                                                                        try {
                                                                                        const code = await sock.requestPairingCode(phoneNumber);
                                                                                                        console.log(`\nYour Pairing Code: ${code}\n`);
                                                                                                                    } catch (err) {
                                                                                                                                    console.log("Error requesting pairing code: ", err);
                                                                                                                                                }
                                                                                                                                                        }, 3000);
                                                                                                                                                            }

                                                                                                                                                                sock.ev.on('creds.update', saveCreds);

                                                                                                                                                                    sock.ev.on('connection.update', (update) => {
                                                                                                                                                                            const { connection, lastDisconnect } = update;
                                                                                                                                                                                    if (connection === 'close') {
                                                                                                                                                                                                const shouldReconnect = lastDisconnect.error?.output?.statusCode !== DisconnectReason.loggedOut;
                                                                                                                                                                                                            if (shouldReconnect) {
                                                                                                                                                                                                                            connectToWhatsApp();
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                } else if (connection === 'open') {
                                                                                                                                                                                                                                                            console.log('âœ… WhatsApp à¦•à¦¾à¦¨à§‡à¦•à§à¦Ÿà§‡à¦¡!');
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                            sock.ev.on('messages.upsert', async m => {
                                                                                                                                                                                                                                                                                    const msg = m.messages[0];
                                                                                                                                                                                                                                                                                            if (!msg.message || msg.key.fromMe) return;

                                                                                                                                                                                                                                                                                                    const remoteJid = msg.key.remoteJid;
                                                                                                                                                                                                                                                                                                            const incomingText = (msg.message.conversation || msg.message.extendedTextMessage?.text || "").trim();

                                                                                                                                                                                                                                                                                                                    if (!incomingText) return; // à¦–à¦¾à¦²à¦¿ à¦®à§‡à¦¸à§‡à¦œ à¦¹à¦²à§‡ à¦•à¦¿à¦›à§ à¦•à¦°à¦¬à§‡ à¦¨à¦¾

                                                                                                                                                                                                                                                                                                                            // à§§. à¦ªà§à¦°à¦¥à¦®à§‡ à¦šà§‡à¦• à¦•à¦°à¦¬à§‡ à¦¬à¦‡ à¦†à¦›à§‡ à¦•à¦¿ à¦¨à¦¾
                                                                                                                                                                                                                                                                                                                                    const foundBook = booksDatabase.find(book => 
                                                                                                                                                                                                                                                                                                                                                book.name.toLowerCase().includes(incomingText.toLowerCase())
                                                                                                                                                                                                                                                                                                                                                        );

                                                                                                                                                                                                                                                                                                                                                                if (foundBook) {
                                                                                                                                                                                                                                                                                                                                                                            // à¦¬à¦‡ à¦ªà¦¾à¦“à§Ÿà¦¾ à¦—à§‡à¦²à§‡ à¦ªà¦¿à¦¡à¦¿à¦à¦« à¦ªà¦¾à¦ à¦¾à¦¬à§‡
                                                                                                                                                                                                                                                                                                                                                                                        await sock.sendMessage(remoteJid, { text: `ðŸ“š à¦ªà§‡à§Ÿà§‡à¦›à¦¿! *${foundBook.name}* à¦¬à¦‡à¦Ÿà¦¿ à¦†à¦ªà¦²à§‹à¦¡ à¦¹à¦šà§à¦›à§‡...` });
                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, { 
                                                                                                                                                                                                                                                                                                                                                                                                                                document: { url: foundBook.link }, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                mimetype: 'application/pdf', 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                fileName: `${foundBook.name}.pdf`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // à§¨. à¦¬à¦‡ à¦¨à¦¾ à¦ªà¦¾à¦“à§Ÿà¦¾ à¦—à§‡à¦²à§‡ AI à¦•à¦¥à¦¾ à¦¬à¦²à¦¬à§‡
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // à¦Ÿà¦¾à¦‡à¦ªà¦¿à¦‚ à¦‡à¦«à§‡à¦•à§à¦Ÿ (à¦¯à§‡à¦¨ à¦®à¦¨à§‡ à¦¹à§Ÿ à¦®à¦¾à¦¨à§à¦· à¦²à¦¿à¦–à¦›à§‡)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendPresenceUpdate('composing', remoteJid); 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const aiResponse = await getGeminiReply(incomingText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sock.sendMessage(remoteJid, { text: aiResponse });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.get('/', (req, res) => res.send('Bot is running'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            app.listen(process.env.PORT || 3000);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            connectToWhatsApp();